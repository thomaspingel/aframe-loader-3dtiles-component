<html>
  <head>
    <!--     <script src="https://threejs.org/build/three.js"></script>  -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handy-work@3.1.9/build/handy-controls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-htmlmesh@2.0.1/build/aframe-html.min.js"></script>

    <script src="aframe-loader-laz-component.min.js"></script>
    <!--     <script src="./lasloader.js" type="module"></script> -->
    <script src="./classifier.js"></script>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <script>
    // add classifications window
    function toggleAddClass() {
      let addwindow = document.getElementById("addcolor");
      if (addwindow.hidden == true) {
        addwindow.hidden = false;
        document.getElementById("plusbtn").innerText = "x";
        document.getElementById("plusbtn").style = "font-size:35px";
        document.getElementById("my-interface").style =
          "background-color:white; width:800px";
      } else {
        addwindow.hidden = true;
        document.getElementById("plusbtn").innerText = "+";
        document.getElementById("plusbtn").style = "font-size:25px";
        document.getElementById("my-interface").style =
          "background-color:white; width:800px";
      }
    }
  </script>
  <a-scene
    webxr="overlayElement:dom-overlay"
    cursor="rayOrigin: mouse"
    raycaster="objects: [html]; interval:100;"
    inspector="url: https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js"
  >
    <a-assets>
      <!-- 			<a-mixin id="blink" blink-controls="collisionEntities: #ground;"></a-mixin> -->
      <a-mixin
        id="blink"
        blink-controls="rotateOnTeleport:true;cameraRig: #cameraRig; teleportOrigin: #head; collisionEntities:#ground;"
      ></a-mixin>
      <a-mixin
        id="raycaster"
        raycaster="showLine: true; far: 2; lineColor: red; objects: [html], #pointcloud; interval:100;"
      ></a-mixin>
    </a-assets>

    <!-- CONTROLS -->
    <!--  -->
    <!--   <a-entity oculus-touch-controls="hand: left" raycaster="objects: .collidable; showLine:true; near: 0.1; far:100 autoRefresh:false" trigger> -->

    <!--   </a-entity> -->
    <a-entity trigger></a-entity>

    <a-entity id="cameraRig" spawn-in-circle="radius:3">
      <!-- camera -->
      <a-entity
        class="avatar-head"
        camera="near:0.01;"
        cursor="rayOrigin: mouse"
        look-controls="pointerLockEnabled: false"
        wasd-controls="acceleration:150;"
        position="0 0 0"
      >
        <!--         <a-entity id="download-buttonid" geometry="primitive: box" material="color: red" position="-3 1 -2.5"></a-entity> -->
        <a-entity
          style="cursor: pointer; transition: all 0.2s ease-in-out"
          id="download-buttonid"
          class="button"
          position="-4 1.7 -2.5"
          geometry="primitive: plane; width: 1; height: 0.3;"
          material="color: #4cc3d9; shader: flat;"
          text="value: Download Cloud - csv; color: white; align: center; width: 2;"
          onmouseenter="this.setAttribute('scale', '1.1 1.1 1.1')"
          onmouseleave="this.setAttribute('scale', '1 1 1')"
        ></a-entity>
      </a-entity>

      <!-- Hand tracking -->
      <!-- 			<a-entity handy-controls > -->

      <!-- These also do teleportaion for Blink controls in VR -->
      <!-- These are present for hand tracking but hands don't have joysticks so do nothing -->
      <a-entity
        oculus-touch-controls="hand: right"
        thumbstick-logging
        id="righthand"
        data-right="ray"
        mixin=""
        cursor
        classify="sphere:sphereR; hand:r"
        raycaster="showLine: true; far: 12; lineColor: red; objects: [html], #pointcloud; interval:100; direction:0 -1 -1"
      >
        <!--           <a-sphere id="sph" position="0 0 -0.2" material="color:yellow; opacity:0.5" scale="0.12 0.12 0.12" classify></a-sphere> -->
      </a-entity>
      <a-entity
        oculus-touch-controls="hand: left"
        thumbstick-logging
        id="lefthand"
        data-left="ray"
        mixin=""
        raycaster="showLine: true; far: 12; lineColor: blue; objects: [html], #pointcloud; interval:100; direction:0 -1 -1"
        cursor
        classify="sphere:sphereL; hand:l"
      >
        <a-entity
          html="cursor:#cursor;html:#my-interface"
          position="-0.042 0.0166 -0.02928"
          rotation="-80 90 0"
          scale="0.5 0.5 0.5"
        ></a-entity>
      </a-entity>

      <!-- markers to let us know the real location of the hands, you probably want to make them visible="false" or just make them empty <a-entities> -->
<!--       <a-entity
        id="left-no-magnet"
        data-left="grip"
        data-no-magnet
        radius="0.01"
      >
      </a-entity>
      <a-entity
        id="right-no-magnet"
        data-right="grip"
        data-no-magnet
        radius="0.01"
      ></a-entity> -->
      <!-- 			</a-entity> -->
    </a-entity>

    <!-- tip spheres -->
    <a-sphere
      id="sphereR"
      position="0 0 0"
      material="color:red; opacity:0.5"
      scale="2 2 2"
    ></a-sphere>

    <a-sphere
      id="sphereL"
      position="0 0 0"
      material="color:lightblue; opacity: 0.5"
      scale="0.2 0.2 0.2"
    ></a-sphere>

    <a-entity
      id="pointcloud"
      position="0 0 -50"
      rotation="270 0 0"
      scale="1 1 1"
      lasloader="
    url: https://rawhitten.github.io/chunk.laz;
    downid: #download-buttonid;
    cameraEl: #camera;
    lefthandEl: #lefthand;
    righthandEl: #righthand;
    pointcloudColoring: classification; 
  "
    >
    </a-entity>
  </a-scene>

    <div id="dom-overlay">
      <section style="display: inline-block; background: white; color: #333333; border-radius: 1em; padding: 1em; margin:0;" id="my-interface">
        
        <fieldset style="border:0 none;border-top: 1px solid grey;">
          <legend>Classification</legend>
          <input onclick="handleRadio(this)" type="radio" id="class-unclassified" name="pc_class" value="0" checked><label for="class-unclassified"> Unclassified</label>
          <input onclick="handleRadio(this)" type="radio" id="class-ground" name="pc_class" value="2" checked><label for="class-ground"> Ground</label>
          <input onclick="handleRadio(this)" type="radio" id="class-vegetation" name="pc_class" value="3" checked><label for="class-veg"> Vegetation</label>
          <input onclick="handleRadio(this)" type="radio" id="class-building" name="pc_class" value="6" checked><label for="class-veg"> Building</label>
        </fieldset>
        
        <h2>Settings</h2>
          <button onclick="AFRAME.scenes[0].exitVR()" style="display: block;">Exit Immersive</button>
      </section>
    </div>

  <script>
    // console.log("Hello")
    const pointcloud = document.getElementById("pointcloud");
    // console.log("pt -")
    // console.log(pointcloud)
    console.log(window.location.search);
    var url = new URL(window.location.href);
    var PTlink = url.searchParams.get("url");
    console.log("Link for redirection:");
    console.log(PTlink);
    if (PTlink != null) {
      pointcloud.setAttribute("lasloader", { url: PTlink });
    }
    function handleRadio(data) {
      console.log(data);
      console.log(data.attributes.value.value);
      console.log(document.getElementById("pointcloud").components.lasloader);
      document
        .getElementById("pointcloud")
        .setAttribute(
          "lasloader",
          "classificationValue",
          data.attributes.value.value
        );
      console.log(
        document.getElementById("pointcloud").components.lasloader.data
          .classificationValue
      );
    }

    function changeColoring(value) {
      //console.log("\'"+value+"\'");
      // console.log(typeof(value));
      console.log(("'" + value + "'").replace("'", "").replace("'", ""));
      //document.getElementById("pointcloud").setAttribute("lasloader","pointcloudColoring", "classification");
      document
        .getElementById("pointcloud")
        .setAttribute("lasloader", "pointcloudColoring", "'" + value + "'");
    }

    console.log("left hand position: ");
    console.log(document.getElementById("lefthand").object3D.position);

    // displays the value of the selected point size below the slider
    let ptsize = document.getElementById("pointsizevalue");
    let slider = document.getElementById("point");
    // ptsize.innerHTML = slider.value;

    // point size slider
    // slider.oninput = function () {
    //   ptsize.innerHTML = this.value;
    //   document
    //     .getElementById("pointcloud")
    //     .setAttribute("lasloader", "pointSize", this.value);
    // };

    // ray length slider
    // let r = document.querySelector("#raylen");
    // console.log(r);
    // r.addEventListener(
    //   "input",
    //   function () {
    //     raylenvalue.innerHTML = r.value;
    //     console.log("ray len changed to " + r.value);
    //     document
    //       .getElementById("lefthand")
    //       .setAttribute("raycaster", "far", r.value);
    //     document
    //       .getElementById("righthand")
    //       .setAttribute("raycaster", "far", r.value);
    //   },
    //   false
    // );

    addcolor = function (value) {
      console.log("adding color " + value);
      document.getElementById("c" + value).hidden = false;
      document.getElementById("a" + value).hidden = true;
    };

    //     url: https://rawhitten.github.io/chunk.laz;
  </script>
</html>
